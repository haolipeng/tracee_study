# åŸºäº eBPF çš„æœ¬åœ°ææƒæ£€æµ‹

---

## 1. eBPF æ£€æµ‹æœ¬åœ°ææƒçš„ Hook ç‚¹é€‰æ‹©

æ£€æµ‹æœ¬åœ°ææƒï¼Œæ ¸å¿ƒé—®é¢˜æ˜¯ï¼š**åœ¨å“ªé‡Œ hook èƒ½æ•è·åˆ°æƒé™å˜åŒ–ï¼Ÿ**

eBPF æä¾›äº†å¤šç§ hook æœºåˆ¶ï¼Œæˆ‘ä»¬æ¥åˆ†æå„è‡ªçš„ä¼˜ç¼ºç‚¹ã€‚

### 1.1 å¯é€‰çš„ Hook ç‚¹

#### æ–¹æ¡ˆä¸€ï¼šTracepoint ç³»ç»Ÿè°ƒç”¨å±‚

Hook æƒé™ç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨ï¼š

```
tracepoint/syscalls/sys_enter_setuid
tracepoint/syscalls/sys_enter_setgid
tracepoint/syscalls/sys_enter_setresuid
tracepoint/syscalls/sys_enter_setresgid
tracepoint/syscalls/sys_enter_setfsuid
tracepoint/syscalls/sys_enter_capset
tracepoint/syscalls/sys_enter_execve
```

**ä¼˜ç‚¹**ï¼š

- ç¨³å®šçš„ ABIï¼Œä¸éšå†…æ ¸ç‰ˆæœ¬å˜åŒ–
- èƒ½è·å–ç”¨æˆ·ç©ºé—´ä¼ å…¥çš„å‚æ•°

**ç¼ºç‚¹**ï¼š
- åªèƒ½çœ‹åˆ°"è¯·æ±‚"ï¼Œä¸çŸ¥é“æ˜¯å¦æˆåŠŸ
- éœ€è¦ hook å¤šä¸ªç³»ç»Ÿè°ƒç”¨æ‰èƒ½è¦†ç›–æ‰€æœ‰åœºæ™¯
- æ— æ³•æ•è·å†…æ ¸æ€çš„æƒé™å˜åŒ–ï¼ˆå¦‚å†…æ ¸æ¼æ´åˆ©ç”¨ï¼‰
- SUID ç¨‹åºæ‰§è¡Œæ—¶çš„æƒé™å˜åŒ–å‘ç”Ÿåœ¨ execve å†…éƒ¨ï¼Œéš¾ä»¥ç›´æ¥è§‚å¯Ÿ

#### æ–¹æ¡ˆäºŒï¼šKprobe ç³»ç»Ÿè°ƒç”¨å…¥å£

```
kprobe/__x64_sys_setuid
kprobe/__x64_sys_setresuid
...
```

**ä¼˜ç‚¹**ï¼š
- æ¯” tracepoint æ›´çµæ´»

**ç¼ºç‚¹**ï¼š
- åŒæ ·åªæ˜¯å…¥å£ï¼Œä¸çŸ¥é“ç»“æœ
- ç¬¦å·åå¯èƒ½éšå†…æ ¸ç‰ˆæœ¬å˜åŒ–

**ä¸ºä»€ä¹ˆè¿™ä¸¤ç§æ–¹æ¡ˆéƒ½ä¸å¤Ÿå¥½ï¼Ÿ**

```
æ­£å¸¸ææƒè·¯å¾„ï¼ˆèƒ½ç›‘æ§åˆ°ï¼‰ï¼š
  ç”¨æˆ·ç¨‹åº â†’ setuid() ç³»ç»Ÿè°ƒç”¨ â†’ å†…æ ¸å¤„ç† â†’ commit_creds

å†…æ ¸æ¼æ´ææƒè·¯å¾„ï¼ˆç›‘æ§ä¸åˆ°ï¼ï¼‰ï¼š
  ç”¨æˆ·ç¨‹åº â†’ è§¦å‘æ¼æ´ â†’ ç›´æ¥åœ¨å†…æ ¸æ€è°ƒç”¨ commit_creds
                  â†‘
                  ç»•è¿‡äº†ç³»ç»Ÿè°ƒç”¨å…¥å£ï¼
```

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¦é€‰æ‹© hook `commit_creds`â€”â€”å®ƒæ˜¯"æœ€ç»ˆå…³å¡"ï¼Œæ— è®ºèµ°æ­£é—¨è¿˜æ˜¯ç¿»å¢™è¿›æ¥ï¼Œæœ€åéƒ½è¦ä»è¿™è¿‡ã€‚

#### æ–¹æ¡ˆä¸‰ï¼šKprobe å†…æ ¸å‡­è¯å‡½æ•°

```
kprobe/commit_creds      â† æœ€ç»ˆæ–¹æ¡ˆ
kprobe/prepare_creds
kprobe/override_creds
```

**ä¼˜ç‚¹**ï¼š
- `commit_creds` æ˜¯æ‰€æœ‰æƒé™å˜åŒ–çš„å¿…ç»ä¹‹è·¯
- ä¸€ä¸ª hook ç‚¹è¦†ç›–æ‰€æœ‰åœºæ™¯
- èƒ½åŒæ—¶è·å–æ–°æ—§å‡­è¯è¿›è¡Œæ¯”è¾ƒ

**ç¼ºç‚¹**ï¼š
- å†…æ ¸å†…éƒ¨å‡½æ•°ï¼Œå¯èƒ½éšç‰ˆæœ¬å˜åŒ–ï¼ˆä½† commit_creds éå¸¸ç¨³å®šï¼‰

#### æ–¹æ¡ˆå››ï¼šLSMï¼ˆLinux Security Modulesï¼‰Hook

```
lsm/cred_prepare
lsm/cred_commit
lsm/task_fix_setuid
```

**ä¼˜ç‚¹**ï¼š
- ä¸“é—¨ä¸ºå®‰å…¨è®¾è®¡çš„ hook ç‚¹
- å¯ä»¥é˜»æ­¢æ“ä½œï¼ˆä¸ä»…æ˜¯æ£€æµ‹ï¼‰

**ç¼ºç‚¹**ï¼š
- éœ€è¦ BPF LSM æ”¯æŒï¼ˆLinux 5.7+ï¼‰
- éƒ¨åˆ†å‘è¡Œç‰ˆé»˜è®¤æœªå¯ç”¨

### 1.2 ä¸ºä»€ä¹ˆé€‰æ‹© kprobe/commit_creds

```
                    ç”¨æˆ·æ€è¯·æ±‚
                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚               â”‚               â”‚
        â–¼               â–¼               â–¼
    setuid()       execve()      å†…æ ¸æ¼æ´åˆ©ç”¨
        â”‚               â”‚               â”‚
        â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
        â”‚    â”‚  (SUIDç¨‹åº)               â”‚
        â–¼    â–¼                          â–¼
    prepare_creds()  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
    [ä¿®æ”¹ cred ç»“æ„]
        â”‚
        â–¼
    commit_creds()  â—„â”€â”€â”€ è¿™é‡Œ hookï¼
        â”‚
        â–¼
    æƒé™å˜åŒ–ç”Ÿæ•ˆ
```

**commit_creds æ˜¯æƒé™å˜åŒ–çš„"å’½å–‰è¦é“"**ï¼š

1. **è¦†ç›–å…¨é¢**ï¼šæ— è®ºæ˜¯ setuidã€execve æ‰§è¡ŒSUID ç¨‹åºï¼Œè¿˜æ˜¯å†…æ ¸æ¼æ´åˆ©ç”¨ï¼Œå…¶æœ€ç»ˆéƒ½è¦è°ƒç”¨ commit_creds
2. **æ—¶æœºç²¾å‡†**ï¼šåœ¨ commit_creds è°ƒç”¨æ—¶ï¼Œæ–°å‡­è¯å·²ç»å‡†å¤‡å¥½ï¼Œå¯ä»¥åŒæ—¶è·å–æ–°æ—§å‡­è¯
3. **ç¨³å®šæ€§å¥½**ï¼šcommit_creds ä» Linux 2.6.29 å¼•å…¥è‡³ä»Šï¼Œæ¥å£æœªå˜
4. **æ€§èƒ½ä¼˜**ï¼šä¸€ä¸ª hook ç‚¹æ›¿ä»£å¤šä¸ªç³»ç»Ÿè°ƒç”¨ hook

### 1.3 Hook ç‚¹å¯¹æ¯”æ€»ç»“

| Hook ç‚¹ | è¦†ç›–åœºæ™¯ | èƒ½å¦æ£€æµ‹å†…æ ¸æ¼æ´ææƒ | æ€§èƒ½ | ç¨³å®šæ€§ |
|---------|----------|---------------------|------|--------|
| tracepoint/syscalls | éƒ¨åˆ† | âœ— | éœ€å¤šä¸ªhook | é«˜ |
| kprobe/__x64_sys_setuidç³»åˆ—å‡½æ•° | éƒ¨åˆ† | âœ— | éœ€å¤šä¸ªhook | ä¸­ |
| **kprobe/commit_creds** | **å…¨éƒ¨** | **âœ“** | **å•hook** | **é«˜** |
| lsm/cred_commit | å…¨éƒ¨ | âœ“ | å•hook | éœ€5.7+ |

---

## 2. commit_creds æ£€æµ‹å®ç°

### 2.1 commit_creds å‡½æ•°åˆ†æ

```c
// å†…æ ¸æºç  kernel/cred.c
int commit_creds(struct cred *new)
{
    struct task_struct *task = current;
    const struct cred *old = task->real_cred;

    // ... å®‰å…¨æ£€æŸ¥ ...

    // æ ¸å¿ƒæµç¨‹:æ›¿æ¢å‡­è¯
    rcu_assign_pointer(task->real_cred, new);
    rcu_assign_pointer(task->cred, new);

    // ... æ¸…ç†æ—§å‡­è¯ ...

    return 0;
}
```

å…³é”®ç‚¹ï¼š
- å‚æ•° `new` æ˜¯å³å°†ç”Ÿæ•ˆçš„æ–°å‡­è¯
- `current->real_cred` æ˜¯å½“å‰çš„æ—§å‡­è¯
- å‡½æ•°æ‰§è¡Œåï¼Œè¿›ç¨‹æƒé™å°±å˜äº†

### 2.2 eBPF æ£€æµ‹ä»£ç 

```c
SEC("kprobe/commit_creds")
int BPF_KPROBE(trace_commit_creds)
{
    // 1. è·å–æ–°å‡­è¯ï¼ˆå‡½æ•°å‚æ•°ï¼‰
    struct cred *new_cred = (struct cred *)PT_REGS_PARM1(ctx);

    // 2. è·å–æ—§å‡­è¯ï¼ˆå½“å‰è¿›ç¨‹çš„ real_credï¼‰
    struct task_struct *task = (struct task_struct *)bpf_get_current_task();
    struct cred *old_cred;
    bpf_probe_read_kernel(&old_cred, sizeof(old_cred), &task->real_cred);

    // 3. è¯»å–æ–°æ—§å‡­è¯çš„å…³é”®å­—æ®µ
    uid_t old_uid, new_uid;
    uid_t old_euid, new_euid;

    bpf_probe_read_kernel(&old_uid, sizeof(old_uid), &old_cred->uid.val);
    bpf_probe_read_kernel(&new_uid, sizeof(new_uid), &new_cred->uid.val);
    bpf_probe_read_kernel(&old_euid, sizeof(old_euid), &old_cred->euid.val);
    bpf_probe_read_kernel(&new_euid, sizeof(new_euid), &new_cred->euid.val);

    // 4. æ£€æµ‹æƒé™æå‡
    // æƒ…å†µ1: UID å˜æˆ 0ï¼ˆå˜æˆ rootï¼‰
    // æƒ…å†µ2: EUID å˜æˆ 0ï¼ˆæœ‰æ•ˆæƒé™å˜æˆ rootï¼‰
    // æƒ…å†µ3: ä»é 0 å˜æˆ 0

    if ((old_euid != 0 && new_euid == 0) ||
        (old_uid != 0 && new_uid == 0)) {
        // æƒé™æå‡ï¼æäº¤äº‹ä»¶
    }

    return 0;
}
```

### 2.3 å®Œæ•´çš„æ£€æµ‹æ•°æ®ç»“æ„

```c
// ç²¾ç®€çš„å‡­è¯ç»“æ„ï¼Œç”¨äºåœ¨ eBPF å’Œç”¨æˆ·ç©ºé—´ä¹‹é—´ä¼ é€’
typedef struct slim_cred {
    uid_t uid;           // çœŸå® UID
    gid_t gid;           // çœŸå® GID
    uid_t suid;          // ä¿å­˜çš„ UID
    gid_t sgid;          // ä¿å­˜çš„ GID
    uid_t euid;          // æœ‰æ•ˆ UID
    gid_t egid;          // æœ‰æ•ˆ GID
    uid_t fsuid;         // æ–‡ä»¶ç³»ç»Ÿ UID
    gid_t fsgid;         // æ–‡ä»¶ç³»ç»Ÿ GID
    u64 cap_inheritable; // å¯ç»§æ‰¿çš„ capabilities
    u64 cap_permitted;   // å…è®¸çš„ capabilities
    u64 cap_effective;   // æœ‰æ•ˆçš„ capabilities
    u64 cap_bset;        // capability è¾¹ç•Œé›†
    u64 cap_ambient;     // ç¯å¢ƒ capabilities
} slim_cred_t;

struct event_t {
    u32 pid;
    u32 tid;
    u32 ppid;
    char comm[16];
    char parent_comm[16];
    slim_cred_t old_cred;
    slim_cred_t new_cred;
};
```

### 2.4 æ£€æµ‹é€»è¾‘

```
                    commit_creds è¢«è°ƒç”¨
                            â”‚
                            â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  è¯»å– old_cred å’Œ new_cred    â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  æ¯”è¾ƒ UID/GID/Capabilities    â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                       â”‚
                â–¼                       â–¼
        å‡­è¯æ— å˜åŒ–               å‡­è¯æœ‰å˜åŒ–
        ï¼ˆå¿½ç•¥æ­¤è¡Œä¸ºï¼‰                      â”‚
                                      â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  æ˜¯å¦ä¸º"æƒé™æå‡"ï¼Ÿ      â”‚
                        â”‚  old_euid!=0 && new_euid==0 â”‚
                        â”‚  æˆ– capabilities å¢åŠ     â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚                           â”‚
                        â–¼                           â–¼
                æ­£å¸¸ææƒï¼ˆsudoç­‰ï¼‰           å¯ç–‘ææƒ
                ï¼ˆè®°å½•ä½†ä¸å‘Šè­¦ï¼‰              ï¼ˆå‘Šè­¦ï¼ï¼‰
```

### 2.5 åŒºåˆ†æ­£å¸¸ææƒå’Œå¯ç–‘ææƒ

å…³é”®é—®é¢˜ï¼šsudoã€su ä¹Ÿä¼šè§¦å‘ commit_credsï¼Œå¦‚ä½•åŒºåˆ†ï¼Ÿ

**æ–¹æ³•ä¸€ï¼šæ£€æŸ¥è¿›ç¨‹å**

```c
// ç™½åå•è¿›ç¨‹
const char *whitelist[] = {"sudo", "su", "login", "sshd", "cron"};

// å¦‚æœæ˜¯ç™½åå•è¿›ç¨‹è§¦å‘çš„ï¼Œé™ä½å‘Šè­¦çº§åˆ«
if (is_in_whitelist(comm)) {
    event.severity = SEVERITY_INFO;
} else {
    event.severity = SEVERITY_HIGH;
}
```

**æ–¹æ³•äºŒï¼šæ£€æŸ¥è¿›ç¨‹é“¾**

```c
// å¯ç–‘åœºæ™¯ï¼šWeb æœåŠ¡å™¨è¿›ç¨‹çš„å­è¿›ç¨‹è·å¾— root
// nginx -> php-fpm -> [æ¶æ„è¿›ç¨‹] -> commit_creds(euid=0)

// æ£€æŸ¥çˆ¶è¿›ç¨‹æ˜¯å¦ä¸ºå·²çŸ¥çš„æœåŠ¡è¿›ç¨‹
if (parent_comm in ["nginx", "apache", "php-fpm", "node"]) {
    event.severity = SEVERITY_CRITICAL;
}
```

**æ–¹æ³•ä¸‰ï¼šæ£€æŸ¥è°ƒç”¨æ ˆ**

```c
// æ­£å¸¸çš„ sudo è°ƒç”¨æ ˆï¼š
// sudo -> setresuid -> commit_creds

// å¯ç–‘çš„å†…æ ¸æ¼æ´åˆ©ç”¨è°ƒç”¨æ ˆï¼š
// [ç”¨æˆ·ç¨‹åº] -> [æ¼æ´è§¦å‘] -> commit_creds
// è°ƒç”¨æ ˆä¸­æ²¡æœ‰ setuid/setresuid ç³»ç»Ÿè°ƒç”¨

// ä½¿ç”¨ bpf_get_stack è·å–è°ƒç”¨æ ˆåˆ†æ
```

---

## 3. å®Œæ•´æ£€æµ‹æ¶æ„


```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·ç©ºé—´                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                 æ£€æµ‹å¼•æ“                      â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚  â”‚ äº‹ä»¶è§£æ â”‚  â”‚ è§„åˆ™åŒ¹é… â”‚  â”‚ å‘Šè­¦è¾“å‡º  â”‚    â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                       â”‚ perf buffer                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    å†…æ ¸ç©ºé—´                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                 eBPF ç¨‹åº                     â”‚  â”‚
â”‚  â”‚                                               â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚  â”‚ kprobe/       â”‚  â”‚ kprobe/           â”‚    â”‚  â”‚
â”‚  â”‚  â”‚ commit_creds  â”‚  â”‚ cap_capable       â”‚    â”‚  â”‚
â”‚  â”‚  â”‚ (æ ¸å¿ƒæ£€æµ‹ç‚¹)   â”‚  â”‚ (capabilityè¯·æ±‚)  â”‚    â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â”‚                                               â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚  â”‚ kprobe/       â”‚  â”‚ lsm/              â”‚    â”‚  â”‚
â”‚  â”‚  â”‚ do_init_moduleâ”‚  â”‚ file_open         â”‚    â”‚  â”‚
â”‚  â”‚  â”‚ (æ¨¡å—åŠ è½½)     â”‚  â”‚ (æ•æ„Ÿæ–‡ä»¶è®¿é—®)    â”‚    â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â”‚                                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


---

## 4. åŠ¨æ‰‹å®éªŒ

> ç†è®ºå­¦å®Œäº†ï¼Œç°åœ¨åŠ¨æ‰‹å®è·µï¼

### 4.1 å¿«é€ŸéªŒè¯ï¼šä½¿ç”¨ Tracee æ£€æµ‹ææƒ

```bash
# ç»ˆç«¯ 1ï¼šå¯åŠ¨ Tracee ç›‘æ§ commit_creds
sudo tracee --events commit_creds

# ç»ˆç«¯ 2ï¼šè§¦å‘ææƒï¼ˆéœ€è¦å…ˆè®¾ç½® SUIDï¼‰
sudo chmod u+s /usr/bin/find
su - testuser  # åˆ‡æ¢åˆ°æ™®é€šç”¨æˆ·
find /etc/passwd -exec whoami \;

# è§‚å¯Ÿç»ˆç«¯ 1 çš„è¾“å‡ºï¼Œåº”è¯¥èƒ½çœ‹åˆ° EUID ä» 1000 å˜æˆ 0
```

### 4.2 å®Œæ•´å®éªŒæ•™ç¨‹

è¯¦ç»†çš„æ”»å‡»å¤ç°å’Œæ£€æµ‹å®ç°ï¼Œè¯·å‚è€ƒï¼š

ğŸ‘‰ **[å®éªŒä¸€ï¼šæœ¬åœ°ææƒæ”»å‡»ä¸æ£€æµ‹](lab-01-privilege-escalation.md)**

å®éªŒå†…å®¹åŒ…æ‹¬ï¼š
- SUID ææƒæ”»å‡»ï¿½ï¿½ç°
- Tracee æ£€æµ‹éªŒè¯
- è‡ªå·±ç¼–å†™ eBPF ææƒæ£€æµ‹ç¨‹åºï¼ˆå®Œæ•´ä»£ç ï¼‰

---

## 5. Tracee ä¸­çš„å®ç°åˆ†æ

### 5.1 Tracee å¦‚ä½•æ£€æµ‹ææƒ

Tracee ä½¿ç”¨ `SetuidEvent` äº‹ä»¶æ¥æ£€æµ‹ææƒï¼š

```go
// pkg/events/core.go ä¸­çš„äº‹ä»¶å®šä¹‰
SetuidEventID = EventID(...)

// äº‹ä»¶ä¼šåŒ…å« old_cred å’Œ new_cred ä¿¡æ¯
```

### 5.2 ç›¸å…³æºç æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `pkg/ebpf/c/tracee.bpf.c` | eBPF ç¨‹åºä¸»æ–‡ä»¶ |
| `pkg/ebpf/c/types.h` | slim_cred_t ç­‰ç±»å‹å®šä¹‰ |
| `pkg/events/core.go` | äº‹ä»¶å®šä¹‰ |
| `signatures/golang/` | ææƒç›¸å…³ç­¾å |

### 5.3 å…³é”®ä»£ç ç‰‡æ®µ

Tracee çš„ slim_cred_t å®šä¹‰ï¼ˆç®€åŒ–ç‰ˆï¼‰ï¼š

```c
// pkg/ebpf/c/types.h
typedef struct slim_cred {
    uid_t uid;
    gid_t gid;
    uid_t suid;
    gid_t sgid;
    uid_t euid;
    gid_t egid;
    uid_t fsuid;
    gid_t fsgid;
    u64 cap_inheritable;
    u64 cap_permitted;
    u64 cap_effective;
    u64 cap_bset;
    u64 cap_ambient;
} slim_cred_t;
```

---

## 6. æ‰©å±•æ£€æµ‹åœºæ™¯

### 6.1 æ£€æµ‹ Capabilities æå‡

é™¤äº† UID å˜åŒ–ï¼Œè¿˜åº”è¯¥æ£€æµ‹ capabilities çš„æå‡ï¼š

```c
// æ£€æµ‹ capabilities å¢åŠ 
u64 old_cap = old_cred->cap_effective;
u64 new_cap = new_cred->cap_effective;

// æ–°å¢çš„ capabilities
u64 added_caps = new_cap & ~old_cap;

if (added_caps != 0) {
    // æ£€æµ‹åˆ° capabilities æå‡
    // ç‰¹åˆ«å…³æ³¨é«˜å±èƒ½åŠ›ï¼š
    // CAP_SYS_ADMIN (21)
    // CAP_SYS_PTRACE (19)
    // CAP_SYS_MODULE (16)
}
```

### 6.2 æ£€æµ‹å®¹å™¨å†…ææƒ

å®¹å™¨å†…çš„ææƒæ›´éœ€è¦å…³æ³¨ï¼š

```c
// è·å– cgroup ID åˆ¤æ–­æ˜¯å¦åœ¨å®¹å™¨ä¸­
u64 cgroup_id = bpf_get_current_cgroup_id();

// å¦‚æœåœ¨å®¹å™¨ä¸­ä¸”å‘ç”Ÿææƒï¼Œä¼˜å…ˆçº§æ›´é«˜
if (is_container(cgroup_id) && is_privilege_escalation) {
    event.severity = CRITICAL;
}
```

### 6.3 æ£€æµ‹å†…æ ¸æ¼æ´åˆ©ç”¨

å†…æ ¸æ¼æ´åˆ©ç”¨é€šå¸¸æœ‰ä»¥ä¸‹ç‰¹å¾ï¼š

```c
// å¯ç–‘ç‰¹å¾ï¼š
// 1. ä¸æ˜¯ä»å·²çŸ¥çš„ææƒç¨‹åºè§¦å‘
// 2. è°ƒç”¨æ ˆå¼‚å¸¸ï¼ˆæ²¡æœ‰ç»è¿‡ setuid ç³»ç»Ÿè°ƒç”¨ï¼‰
// 3. è¿›ç¨‹åæ˜¯æ™®é€šç¨‹åºï¼ˆé sudo/suï¼‰

// ä½¿ç”¨ bpf_get_stack è·å–è°ƒç”¨æ ˆ
int ret = bpf_get_stack(ctx, stack, sizeof(stack), BPF_F_USER_STACK);
// åˆ†æè°ƒç”¨æ ˆä¸­æ˜¯å¦æœ‰å¼‚å¸¸
```

---

## 7. æ€§èƒ½è€ƒé‡

### 7.1 commit_creds è°ƒç”¨é¢‘ç‡

- `commit_creds` ä¸æ˜¯é«˜é¢‘è°ƒç”¨çš„å‡½æ•°
- å¤§å¤šæ•°è¿›ç¨‹å¯åŠ¨æ—¶ä¼šè°ƒç”¨ä¸€æ¬¡
- sudo/su ç­‰å‘½ä»¤ä¼šè§¦å‘
- å¯¹ç³»ç»Ÿæ€§èƒ½å½±å“å¾ˆå°

### 7.2 ä¼˜åŒ–å»ºè®®

```c
// 1. æ—©æœŸè¿‡æ»¤ï¼šåœ¨ eBPF ä¸­å°±è¿‡æ»¤æ‰ä¸éœ€è¦çš„äº‹ä»¶
if (old_euid == new_euid && old_uid == new_uid) {
    return 0;  // æ²¡æœ‰å˜åŒ–ï¼Œç›´æ¥è¿”å›
}

// 2. ä½¿ç”¨ BPF Maps ç¼“å­˜ç™½åå•
// é¿å…æ¯æ¬¡éƒ½æ¯”è¾ƒå­—ç¬¦ä¸²
```

---

## 8. å…³è”æ–‡æ¡£

| æ–‡æ¡£ | è¯´æ˜ |
|------|------|
| [æœ¬åœ°ææƒæ”»å‡»æŠ€æœ¯](local-privilege-escalation-attacks.md) | æ”»å‡»åŸç†å’Œæ‰‹æ³• |
| [å®éªŒä¸€ï¼šææƒæ”»é˜²](lab-01-privilege-escalation.md) | åŠ¨æ‰‹å®éªŒæ•™ç¨‹ |
| [æ ¸å¿ƒæ¦‚å¿µé€šä¿—è§£é‡Š](concepts-explained.md) | cred ç»“æ„ç­‰æ¦‚å¿µ |
| [eBPF å®ç°è¯¦è§£](03-ebpf-implementation.md) | Tracee çš„ eBPF å®ç° |

---

## 9. å‚è€ƒèµ„æ–™

- [Linux å†…æ ¸ cred.c](https://elixir.bootlin.com/linux/latest/source/kernel/cred.c)
- [eBPF CO-RE å‚è€ƒ](https://nakryiko.com/posts/bpf-portability-and-co-re/)
- [Tracee å®˜æ–¹æ–‡æ¡£](https://aquasecurity.github.io/tracee/)
- [MITRE ATT&CK - Privilege Escalation](https://attack.mitre.org/tactics/TA0004/)

---

_æœ€åæ›´æ–°ï¼š2026-02-15_
